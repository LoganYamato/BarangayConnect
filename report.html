<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPrpZYIJYhAmZRxW0Ph3udw-vUz6UiPNk",
  authDomain: "iss-bc.firebaseapp.com",
  projectId: "iss-bc",
  storageBucket: "iss-bc.firebasestorage.app",
  messagingSenderId: "455122393981",
  appId: "1:455122393981:web:bdf281da744767c0064a14",
  measurementId: "G-6VQLV0PG81"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const reportForm = document.getElementById("reportForm");
const reportsContainer = document.getElementById("reportsContainer");

// üü¶ Submit Report
reportForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const issue = document.getElementById("issue").value;
  const brgy = document.getElementById("brgy").value;
  const street = document.getElementById("street").value;
  const desc = document.getElementById("description").value;
  const imageUpload = document.getElementById("imageUpload");

  const currentUser = JSON.parse(localStorage.getItem("currentUser")) || {};
  const author = currentUser.name || "Anonymous Resident";

  // Convert image to Base64
  let imageData = null;
  if (imageUpload.files[0]) {
    const file = imageUpload.files[0];
    imageData = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.readAsDataURL(file);
    });
  }

  try {
    await addDoc(collection(db, "reports"), {
      issueType: issue,
      barangay: brgy,
      location: street,
      description: desc,
      imageData: imageData || null,
      author,
      status: "Pending",
      timestamp: serverTimestamp()
    });

    alert("‚úÖ Report submitted successfully!");
    reportForm.reset();
    loadReports(); // Refresh after submitting
  } catch (error) {
    console.error("Error submitting report:", error);
    alert("‚ùå Failed to submit report. Try again.");
  }
});

// üü© Load Reports
async function loadReports() {
  reportsContainer.innerHTML = "<p>Loading your reports...</p>";

  const currentUser = JSON.parse(localStorage.getItem("currentUser")) || {};
  const author = currentUser.name || "Anonymous Resident";

  const q = query(collection(db, "reports"), where("author", "==", author), orderBy("timestamp", "desc"));
  const querySnap = await getDocs(q);

  reportsContainer.innerHTML = "";

  if (querySnap.empty) {
    reportsContainer.innerHTML = "<p>No reports submitted yet.</p>";
    return;
  }

  querySnap.forEach((doc) => {
    const r = doc.data();
    const div = document.createElement("div");
    div.className = "report-item";
    div.innerHTML = `
      <h4>${r.issueType}</h4>
      <p><strong>Barangay:</strong> ${r.barangay}</p>
      <p><strong>Location:</strong> ${r.location}</p>
      <p>${r.description}</p>
      ${r.imageData ? `<img src="${r.imageData}" alt="Report Image">` : ""}
      <p><small>Status: ${r.status || "Pending"}</small></p>
      <p><small>${r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString() : ""}</small></p>
    `;
    reportsContainer.appendChild(div);
  });
}

// Auto-load reports when page opens
loadReports();
</script>