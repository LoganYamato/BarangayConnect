<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Exec Field Work — Barangay Santa Cruz</title>
<style>
:root{
  --blue:#1e5bb8; --blue-600:#174a95; --blue-50:#f3f8ff; --white:#fff;
  --gray-50:#f9fafb; --gray-200:#e5e7eb; --gray-300:#d1d5db; --gray-500:#6b7280; --gray-700:#374151;
  --green:#16a34a; --amber:#d97706;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;background:var(--blue-50);color:#0f172a}
header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--blue),var(--blue-600));color:var(--white);padding:12px 14px;display:flex;gap:10px;align-items:center}
.logo{width:36px;height:36px;border-radius:10px;background:var(--white);color:var(--blue);display:grid;place-items:center;font-weight:800}
.h1{font-weight:800;font-size:16px}
.sub{font-size:12px;opacity:.9}
.container{max-width:720px;margin:0 auto;padding:12px}
.card{background:var(--white);border:1px solid var(--gray-200);border-radius:14px;padding:12px}
.row{display:flex;gap:8px;align-items:center}
.stack{display:flex;flex-direction:column;gap:10px}
label.small{font-size:12px;color:var(--gray-700)}
input,textarea,select{width:100%;padding:11px;border:1px solid var(--gray-300);border-radius:10px;background:var(--gray-50)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700;background:var(--blue);color:var(--white)}
.btn.secondary{background:var(--white);color:var(--blue);border:1px solid var(--blue)}
.btn.ghost{background:transparent;border:1px dashed var(--blue);color:var(--blue)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.pill{border:1px solid var(--gray-300);background:#fff;padding:4px 8px;border-radius:999px;font-size:11px;color:var(--gray-700)}
.section h3{margin:0 0 8px 0;color:var(--blue);font-size:14px}
.status{display:flex;gap:6px;flex-wrap:wrap}
.status .s{padding:8px 10px;border-radius:10px;border:1px solid var(--gray-300);background:#fff;font-size:12px;cursor:pointer}
.status .s.active{border-color:var(--blue);box-shadow:0 0 0 2px rgba(30,91,184,.15)}
.kv{display:grid;grid-template-columns:110px 1fr;gap:6px;font-size:13px}
.timeline{display:flex;flex-direction:column-reverse;gap:8px;max-height:240px;overflow:auto;border:1px solid var(--gray-200);border-radius:12px;background:#fff;padding:10px}
.tick{display:flex;gap:8px}
.dot{width:10px;height:10px;border-radius:50%;background:var(--blue);margin-top:5px}
.content{background:var(--blue-50);border:1px solid var(--gray-200);padding:8px;border-radius:10px;flex:1}
.meta{font-size:12px;color:var(--gray-500)}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
.thumb{height:90px;border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;display:grid;place-items:center;background:var(--gray-50)}
.thumb img,.thumb video{width:100%;height:100%;object-fit:cover}
footer{padding:24px;text-align:center;color:var(--gray-500)}
/* Map container */
.map{height:260px;border:1px solid var(--gray-200);border-radius:12px;background:#e6eefc;overflow:hidden}
</style>
<!-- Leaflet (OpenStreetMap) - no API key required -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
</head>
<body>
<header>
  <div class="logo">BC</div>
  <div class="stack" style="gap:2px">
    <div class="h1">Exec Field Work — Updates & Proof</div>
    <div class="sub">Barangay Santa Cruz, Makati City • Mobile-first</div>
  </div>
</header>

<main class="container stack">
  <!-- Ticket Picker / Creator (minimal) -->
  <section class="card stack">
    <div class="section">
      <h3>Ticket</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input id="ticketId" placeholder="Enter Ticket ID (e.g., 2025-101)"/>
        <button class="btn" id="loadBtn">Open</button>
        <button class="btn secondary" id="newBtn">New</button>
      </div>
      <div class="kv" id="kv"></div>
    </div>

    <div class="section">
      <h3>Status</h3>
      <div class="status" id="statusBar"></div>
      <div class="row" style="justify-content:space-between">
        <span class="pill">Current: <b id="statusNow">—</b></span>
        <span class="pill">Last updated: <b id="lastTs">—</b></span>
      </div>
    </div>

    <div class="section">
      <h3>Post Field Update</h3>
      <textarea id="updateText" rows="3" placeholder="Write a short status update for the resident…"></textarea>
      <div class="row" style="justify-content:space-between;flex-wrap:wrap">
        <label class="small">Attach proof-of-work media
          <input id="media" type="file" accept="image/*,video/*" capture="environment" multiple>
        </label>
        <button class="btn" id="postBtn">Post Update</button>
      </div>
    </div>
  </section>

  <!-- Map — Pinpoint Fieldwork -->
  <section class="card stack">
    <div class="section">
      <h3>Map — Pinpoint Fieldwork</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button class="btn" id="geoBtn">Use My Location</button>
        <button class="btn secondary" id="clearPinBtn">Clear Pin</button>
      </div>
      <div id="map" class="map" role="img" aria-label="Map to set fieldwork pin">Loading map…</div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <span class="pill">Lat: <b id="latOut">—</b></span>
        <span class="pill">Lng: <b id="lngOut">—</b></span>
      </div>
      <div class="small" id="mapHint">Tip: Tap the map to drop/move the pin. Saves to this ticket.</div>
    </div>
  </section>

  <!-- Timeline & Gallery -->
  <section class="card stack">
    <div class="section">
      <h3>Timeline</h3>
      <div class="timeline" id="timeline"></div>
    </div>
    <div class="section">
      <h3>Proof-of-Work Gallery</h3>
      <div class="gallery" id="gallery"></div>
    </div>
  </section>
</main>

<footer>Prototype only. Data is saved in your browser (localStorage). © 2025 BarangayConnect</footer>

<script>
// ===== Utilities =====
const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
const nowISO = ()=>new Date().toISOString();
const fmt = ts=> new Date(ts).toLocaleString();
const DBKEY='bc_exec_fw_min';
const store = { load(){ return JSON.parse(localStorage.getItem(DBKEY)||'{}'); }, save(d){ localStorage.setItem(DBKEY, JSON.stringify(d)); } };
let DB = store.load(); // { [ticketId]: { id, status, history:[{ts,text}], media:[{id,type,data,ts,caption}], lat, lng } }

// default statuses (execution-focused)
const STATUSES = ['IN-PROGRESS','WAITING-PARTS','RESOLVED','CLOSED','REOPENED'];

// ===== State =====
let current = null; // ticket object

function ensureTicket(id){
  if(!DB[id]){
    DB[id] = { id, status:'IN-PROGRESS', history:[{ts:nowISO(), text:'Ticket created on device.'}], media:[] };
    store.save(DB);
  }
  return DB[id];
}

// ===== UI Bindings =====
$('#loadBtn').onclick = ()=>{
  const id = $('#ticketId').value.trim(); if(!id){ alert('Enter a Ticket ID'); return; }
  current = ensureTicket(id); renderAll();
};
$('#newBtn').onclick = ()=>{
  const id = prompt('New Ticket ID (e.g., 2025-102):'); if(!id) return; $('#ticketId').value=id; current=ensureTicket(id); renderAll();
};

function renderAll(){
  renderKV(); buildStatusBar(); renderTimeline(); renderGallery();
}

function renderKV(){
  const kv = $('#kv'); if(!current){ if(kv) kv.innerHTML=''; return; }
  const lat = current.lat!=null ? current.lat.toFixed(6) : '—';
  const lng = current.lng!=null ? current.lng.toFixed(6) : '—';
  if(kv){
    kv.innerHTML = `
      <div class="small">Ticket ID</div><div>#${current.id}</div>
      <div class="small">Status</div><div id="kvStatus">${current.status}</div>
      <div class="small">Updates</div><div>${current.history.length}</div>
      <div class="small">Coordinates</div><div><span class="pill">${lat}</span> <span class="pill">${lng}</span></div>
    `;
  }
  const statusNow = $('#statusNow'); if(statusNow) statusNow.textContent = current.status;
  const lastTs = $('#lastTs'); if(lastTs) lastTs.textContent = fmt(current.history[current.history.length-1].ts);
  const latOut = $('#latOut'); if(latOut) latOut.textContent = lat;
  const lngOut = $('#lngOut'); if(lngOut) lngOut.textContent = lng;
}

function buildStatusBar(){
  const bar = $('#statusBar'); bar.innerHTML=''; if(!current) return;
  STATUSES.forEach(s=>{
    const b = document.createElement('button'); b.className='s'+(current.status===s?' active':''); b.textContent=s;
    b.onclick=()=>{ setStatus(s); };
    bar.appendChild(b);
  });
}

function setStatus(s){ if(!current) return; current.status=s; addHistory(`Status changed to ${s}`); store.save(DB); renderKV(); buildStatusBar(); }

$('#postBtn').onclick = async ()=>{
  if(!current){ alert('Open or create a ticket first.'); return; }
  const txt = $('#updateText').value.trim();
  const files = Array.from($('#media').files||[]);
  if(!txt && files.length===0){ alert('Write an update or attach media.'); return; }
  if(txt){ addHistory(`Field update: ${txt}`); $('#updateText').value=''; }
  if(files.length){ await addMedia(files); $('#media').value=''; }
  store.save(DB); renderTimeline(); renderGallery(); renderKV();
};

function addHistory(text){ current.history.push({ts:nowISO(), text}); }

async function addMedia(files){
  for(const f of files){
    const data = await readFileDataURL(f);
    current.media.push({ id: Math.random().toString(36).slice(2,9), type:f.type, name:f.name, data, ts:nowISO() });
    addHistory(`Added media: ${f.name}`);
  }
}

function readFileDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

function renderTimeline(){
  const tl = $('#timeline'); tl.innerHTML=''; if(!current) return;
  current.history.forEach(h=>{
    const t = document.createElement('div'); t.className='tick';
    t.innerHTML = `<div class="dot"></div><div class="content"><div class="meta">${fmt(h.ts)}</div><div>${h.text}</div></div>`;
    tl.appendChild(t);
  });
}

function renderGallery(){
  const g = $('#gallery'); g.innerHTML=''; if(!current) return;
  current.media.forEach(m=>{
    const d = document.createElement('div'); d.className='thumb';
    if(m.type.startsWith('image/')){ const img=new Image(); img.src=m.data; d.appendChild(img); }
    else { const v=document.createElement('video'); v.src=m.data; v.controls=true; d.appendChild(v); }
    g.appendChild(d);
  });
}

// Auto-focus ticket field on load (mobile-friendly)
window.addEventListener('load', ()=>{ $('#ticketId').focus(); });

// ===== Leaflet (OpenStreetMap) Integration — No API Key Required =====
let lmap=null, lmarker=null;

function initLeaflet(){
  if(lmap){ lmap.remove(); lmap=null; }
  lmap = L.map('map', { zoomControl:true }).setView([14.5668, 121.0270], 17); // Barangay Santa Cruz approx
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(lmap);

  // click to drop/move pin
  lmap.on('click', (e)=> setPin(e.latlng.lat, e.latlng.lng, true));

  // if ticket already has coords, reflect it
  if(current && current.lat!=null && current.lng!=null){
    setPin(current.lat, current.lng, false);
    lmap.setView([current.lat, current.lng], 18);
  }
}

function setPin(lat,lng,log=false){
  if(!current){ alert('Open or create a ticket first.'); return; }

  if(!lmarker){
    lmarker = L.marker([lat,lng], {draggable:true}).addTo(lmap);
    lmarker.bindPopup('Fieldwork here').openPopup();
    lmarker.on('dragend', ()=>{ const p=lmarker.getLatLng(); setPin(p.lat, p.lng, true); });
  } else {
    lmarker.setLatLng([lat,lng]);
    lmarker.getPopup()?.setContent('Fieldwork here');
    lmarker.openPopup();
  }

  current.lat = lat; current.lng = lng;
  if(log) addHistory(`Pinned location at ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
  store.save(DB); renderKV();
}

$('#geoBtn').onclick = ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude:lat, longitude:lng} = pos.coords;
    if(!lmap) initLeaflet();
    lmap.setView([lat,lng], 18);
    setPin(lat,lng,true);
  }, err=>{ alert('Could not fetch location: '+err.message); }, {enableHighAccuracy:true, maximumAge:20000, timeout:10000});
};

$('#clearPinBtn').onclick = ()=>{
  if(!current){ alert('Open or create a ticket first.'); return; }
  if(lmarker){ lmap.removeLayer(lmarker); lmarker=null; }
  const hadCoords = current.lat!=null || current.lng!=null;
  current.lat = null; current.lng = null;
  if(hadCoords){ addHistory('Cleared fieldwork pin.'); }
  store.save(DB); renderKV();
};

// When switching/creating tickets, reflect pin on map if available
const _renderAll = renderAll;
renderAll = function(){
  _renderAll();
  if(!lmap) initLeaflet();
  if(current && current.lat!=null){
    lmap.setView([current.lat,current.lng], 17);
    setPin(current.lat,current.lng,false);
  } else {
    if(lmarker){ lmap.removeLayer(lmarker); lmarker=null; }
  }
};

// Initialize map on load
window.addEventListener('load', ()=>{ initLeaflet(); });

</script>
</body>
</html>
