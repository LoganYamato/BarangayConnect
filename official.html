<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Official Report Viewer — Barangay Santa Cruz</title>
<link rel="stylesheet" href="style.css">

<!-- Leaflet (for map) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<style>
main{max-width:720px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:16px}
.report-card{background:var(--white);border:1px solid var(--gray-200);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:8px}
.report-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.status-pill{border:1px solid var(--gray-300);border-radius:999px;padding:4px 8px;font-size:12px}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;margin-top:8px}
.thumb{border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;background:var(--gray-50);height:90px;display:grid;place-items:center}
.thumb img,.thumb video{width:100%;height:100%;object-fit:cover}
.tag-btn{background:var(--blue);color:white;border:none;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px}
.tag-btn.reviewed{background:var(--green)}
#map{height:260px;border:1px solid var(--gray-200);border-radius:12px;background:#e6eefc}
</style>
</head>
<body>
<header>
  <div class="logo">BC</div>
  <div class="stack" style="gap:2px">
    <div class="h1">Official Report Viewer</div>
    <div class="sub">Barangay Santa Cruz, Makati City</div>
  </div>
</header>

<main>
  <section class="report-card">
    <div class="report-header">
      <div>
        <strong>Report ID:</strong> <span id="reportId">—</span>
      </div>
      <div>
        <span class="status-pill" id="reportStatus">—</span>
      </div>
    </div>

    <div class="kv">
      <div class="small">Last Update</div><div id="reportLast">—</div>
      <div class="small">Coordinates</div><div><span id="latVal">—</span>, <span id="lngVal">—</span></div>
    </div>

    <h4 style="margin-top:10px;color:var(--blue)">Recent Updates</h4>
    <div id="timeline" style="font-size:13px"></div>

    <h4 style="margin-top:10px;color:var(--blue)">Proof Media</h4>
    <div class="gallery" id="gallery"></div>

    <h4 style="margin-top:10px;color:var(--blue)">Location</h4>
    <div id="map"></div>

    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end">
      <button class="tag-btn" id="markReviewed">Mark as Reviewed</button>
    </div>
  </section>
</main>

<footer>Prototype only. Viewing locally saved reports. © 2025 BarangayConnect</footer>

<script>
const $ = s=>document.querySelector(s);
const DBKEY='bc_exec_fw_min';
let DB = JSON.parse(localStorage.getItem(DBKEY)||'{}');
let currentId = Object.keys(DB)[0]; // load first report if available
let current = DB[currentId] || null;

function fmt(ts){ return new Date(ts).toLocaleString(); }

function render(){
  if(!current){ alert('No reports found.'); return; }
  $('#reportId').textContent = current.id;
  $('#reportStatus').textContent = current.status || '—';
  $('#reportLast').textContent = current.history?.length ? fmt(current.history[current.history.length-1].ts) : '—';
  $('#latVal').textContent = current.lat!=null ? current.lat.toFixed(6) : '—';
  $('#lngVal').textContent = current.lng!=null ? current.lng.toFixed(6) : '—';

  // Timeline
  const tl = $('#timeline');
  tl.innerHTML = '';
  (current.history||[]).slice().reverse().forEach(h=>{
    const div = document.createElement('div');
    div.innerHTML = `<div style="margin-bottom:6px"><strong>${fmt(h.ts)}</strong><br>${h.text}</div>`;
    tl.appendChild(div);
  });

  // Gallery
  const g = $('#gallery');
  g.innerHTML='';
  (current.media||[]).forEach(m=>{
    const d=document.createElement('div');d.className='thumb';
    if(m.type.startsWith('image/')){ const img=new Image(); img.src=m.data; d.appendChild(img); }
    else { const v=document.createElement('video'); v.src=m.data; v.controls=true; d.appendChild(v); }
    g.appendChild(d);
  });

  // Map
  initMap();
}

let lmap=null,lmarker=null;
function initMap(){
  if(lmap){ lmap.remove(); lmap=null; }
  lmap = L.map('map').setView([14.5668,121.027],17);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(lmap);
  if(current && current.lat!=null){
    lmarker=L.marker([current.lat,current.lng]).addTo(lmap);
    lmarker.bindPopup('Reported Location').openPopup();
  }
}

$('#markReviewed').onclick = ()=>{
  if(!current) return;
  if(current.status!=='REVIEWED'){
    current.status='REVIEWED';
    DB[current.id]=current;
    localStorage.setItem(DBKEY,JSON.stringify(DB));
    $('#reportStatus').textContent='REVIEWED';
    $('#markReviewed').classList.add('reviewed');
    $('#markReviewed').textContent='Reviewed ✓';
  }
};

window.addEventListener('load',render);
</script>
</body>
</html>