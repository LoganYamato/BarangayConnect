<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Official Dashboard — BarangayConnect</title>

  <!-- Basic styles + responsive two-column layout -->
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --blue:#1e5bb8; --green:#16a34a; --muted:#f4f6fb; --card:#ffffff;
      --text:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--muted);color:var(--text)}
    header{background:linear-gradient(90deg,var(--blue),#174a95);color:white;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header .brand{display:flex;gap:12px;align-items:center}
    header h1{font-size:18px;margin:0}
    #logoutBtn{background:#dc3545;border:0;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
    main{display:grid;grid-template-columns:360px 1fr;gap:18px;padding:18px;max-width:1200px;margin:18px auto}
    /* make responsive single-column on narrow screens */
    @media (max-width:900px){ main{grid-template-columns:1fr; padding:12px; } }

    /* Left column (list + filters) */
    .panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .filter-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .filter-row select{padding:8px;border-radius:8px;border:1px solid #e6eefc}
    #reportList{list-style:none;margin:0;padding:0;max-height:72vh;overflow:auto}
    #reportList li{padding:12px;border-radius:8px;margin-bottom:8px;border:1px solid #eef3ff;cursor:pointer}
    #reportList li:hover{background:#f8fbff}
    #reportList li.selected{background:#e6f6ee;border-left:4px solid var(--blue);font-weight:600}

    /* detail column */
    .detail-grid{display:flex;flex-direction:column;gap:12px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;padding:10px 0}
    .pill{padding:6px 8px;border-radius:999px;border:1px solid #e6eefc;background:#fff;display:inline-block}
    textarea{width:100%;min-height:80px;padding:10px;border-radius:8px;border:1px solid #e6eefc}
    .btn{background:var(--blue);color:white;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--blue);border:1px solid var(--blue)}
    .status-buttons{display:flex;gap:8px;flex-wrap:wrap}
    #map{height:320px;border-radius:10px;border:1px solid #e6eefc}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
    .thumb{height:90px;border-radius:8px;overflow:hidden;border:1px solid #eef3ff;display:grid;place-items:center;background:#fafcff}
    .thumb img, .thumb video{width:100%;height:100%;object-fit:cover}
    .small{font-size:13px;color:#516179}
    .muted{color:#6b7280;font-size:13px}
  </style>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <div style="width:44px;height:44px;border-radius:8px;background:white;color:var(--blue);display:grid;place-items:center;font-weight:800"><img src="logo.png" alt="Barangay Logo" class="logo"> </div>
    <div>
      <h1>BarangayConnect — Official Dashboard</h1>
      <div class="muted" id="subHeader">Barangay — <span id="officialBarangay">—</span></div>
    </div>
  </div>

  <div>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<main>
  <!-- LEFT: List + Filters -->
  <aside class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">Reports</h3>
      <div class="muted small">Local / Firestore</div>
    </div>

    <div class="filter-row">
      <select id="filterStatus">
        <option value="All">All statuses</option>
        <option value="Pending">Pending</option>
        <option value="In Progress">In Progress</option>
        <option value="Resolved">Resolved</option>
      </select>
      <input id="searchInput" placeholder="Search issue / street" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eefc" />
      <button id="refreshBtn" class="btn secondary">Refresh</button>
    </div>

    <ul id="reportList" aria-live="polite"></ul>
  </aside>

  <!-- RIGHT: Detail panel -->
  <section class="panel detail-grid">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="detailTitle" style="margin:0">Select a report</h2>
          <div class="muted small" id="detailSub">Click a report from the list to view details.</div>
        </div>
        <div>
          <span class="pill" id="detailStatus">—</span>
        </div>
      </div>

      <div class="kv" style="margin-top:12px">
        <div class="small">Issue Type</div><div id="detailIssue">—</div>
        <div class="small">Location</div><div id="detailLocation">—</div>
        <div class="small">Reported By</div><div id="detailAuthor">—</div>
        <div class="small">Submitted</div><div id="detailTimestamp">—</div>
        <div class="small">Description</div><div id="detailDesc">—</div>
      </div>
    </div>

    <!-- Status controls -->
    <div>
      <h4 style="margin:6px 0">Change status</h4>
      <div class="status-buttons" id="statusBar"></div>
    </div>

    <!-- Post update -->
    <div>
      <h4 style="margin:6px 0">Post update</h4>
      <textarea id="updateText" placeholder="Write a short update for the resident..."></textarea>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input id="updateMedia" type="file" accept="image/*,video/*" multiple />
        <button id="postUpdateBtn" class="btn">Post Update</button>
      </div>
    </div>

    <!-- Timeline + gallery + map -->
    <div style="display:grid;grid-template-columns:1fr 240px;gap:12px">
      <div>
        <h4 style="margin:6px 0">Timeline</h4>
        <div id="timeline" style="max-height:150px;overflow:auto;padding:8px;border-radius:8px;background:#fbfdff;border:1px solid #eef3ff"></div>
        <h4 style="margin:8px 0 6px 0">Proof Media</h4>
        <div class="gallery" id="proofGallery"></div>
      </div>
      <div>
        <h4 style="margin:6px 0">Map</h4>
        <div id="map"></div>
        <div style="display:flex;gap:8px;margin-top:8px;justify-content:space-between">
          <span class="pill small">Lat: <b id="latOut">—</b></span>
          <span class="pill small">Lng: <b id="lngOut">—</b></span>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Firebase + App logic (module) -->
<script type="module">
  // --- Firebase imports ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, query, where, getDocs,
    doc, getDoc, updateDoc, arrayUnion, serverTimestamp, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // --- Your firebase config (from earlier) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDPrpZYIJYhAmZRxW0Ph3udw-vUz6UiPNk",
    authDomain: "iss-bc.firebaseapp.com",
    projectId: "iss-bc",
    storageBucket: "iss-bc.firebasestorage.app",
    messagingSenderId: "455122393981",
    appId: "1:455122393981:web:bdf281da744767c0064a14"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // --- Elements & UI state ---
  const reportListEl = document.getElementById("reportList");
  const filterStatusEl = document.getElementById("filterStatus");
  const searchInputEl = document.getElementById("searchInput");
  const refreshBtn = document.getElementById("refreshBtn");

  const detailTitle = document.getElementById("detailTitle");
  const detailSub = document.getElementById("detailSub");
  const detailIssue = document.getElementById("detailIssue");
  const detailLocation = document.getElementById("detailLocation");
  const detailAuthor = document.getElementById("detailAuthor");
  const detailTimestamp = document.getElementById("detailTimestamp");
  const detailDesc = document.getElementById("detailDesc");
  const detailStatus = document.getElementById("detailStatus");

  const statusBar = document.getElementById("statusBar");
  const updateText = document.getElementById("updateText");
  const updateMedia = document.getElementById("updateMedia");
  const postUpdateBtn = document.getElementById("postUpdateBtn");
  const timelineEl = document.getElementById("timeline");
  const proofGallery = document.getElementById("proofGallery");

  const latOut = document.getElementById("latOut");
  const lngOut = document.getElementById("lngOut");
  const officialBarangayEl = document.getElementById("officialBarangay");

  // --- Map setup (Leaflet) ---
  let map = L.map("map", { zoomControl: true }).setView([14.5585, 121.0271], 15);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 20 }).addTo(map);
  let currentMarker = null;

  // --- Authentication + access control (client-side prototype) ---
  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if (!currentUser || currentUser.role !== "official") {
    alert("Unauthorized. Please login as an official.");
    window.location.href = "index.html";
  }
  // show barangay in header
  officialBarangayEl.textContent = currentUser.barangay || "Santa Cruz";

  // logout handler
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
  });

  // --- Local state for loaded reports ---
  let allReports = []; // array of { id, data... }
  let selectedReport = null;

  // Helpful utility
  const fmt = ts => {
    try {
      return new Date(ts.seconds ? ts.seconds * 1000 : ts).toLocaleString();
    } catch (e) {
      return new Date().toLocaleString();
    }
  };

  // Load reports for this official's barangay from Firestore
  async function loadReports() {
    reportListEl.innerHTML = "<li class='small muted'>Loading reports…</li>";
    allReports = [];

    try {
      const q = query(
        collection(db, "reports"),
        where("barangay", "==", (currentUser.barangay || "Santa Cruz"))
      );

      const snaps = await getDocs(q);
      snaps.forEach(snap => {
        allReports.push({ id: snap.id, ...snap.data() });
      });

      // initial render
      renderReportList();
    } catch (err) {
      console.error("loadReports error", err);
      reportListEl.innerHTML = `<li class="muted small">Failed to load reports. Check console.</li>`;
    }
  }

  // Render report list with filter + search
  function renderReportList() {
    const statusFilter = filterStatusEl.value;
    const q = (searchInputEl.value || "").trim().toLowerCase();

    const filtered = allReports.filter(r => {
      const statusMatch = (statusFilter === "All") || (r.status === statusFilter);
      const text = `${r.issueType||r.issue||""} ${r.location||""} ${r.author||r.name||""}`.toLowerCase();
      const searchMatch = !q || text.includes(q);
      return statusMatch && searchMatch;
    });

    if (filtered.length === 0) {
      reportListEl.innerHTML = `<li class="muted small">No reports found.</li>`;
      return;
    }

    reportListEl.innerHTML = "";
    filtered.forEach((r, idx) => {
      const li = document.createElement("li");
      li.tabIndex = 0;
      li.dataset.id = r.id;
      li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>${r.issueType||r.issue||"Issue"}</strong><div class="muted small">${r.location||"Unknown"}</div></div>
                        <div class="muted small">${r.status || "Pending"}</div>
                      </div>`;
      li.addEventListener("click", () => selectReport(r.id));
      // keyboard accessibility
      li.addEventListener("keypress", e => { if (e.key === "Enter") selectReport(r.id); });

      reportListEl.appendChild(li);
    });
  }

  // Select a report by id -> load details and show on map
  async function selectReport(reportId) {
    // visually mark selected in list
    document.querySelectorAll("#reportList li").forEach(li => li.classList.remove("selected"));
    const selectedLi = document.querySelector(`#reportList li[data-id="${reportId}"]`);
    if (selectedLi) selectedLi.classList.add("selected");

    // fetch latest doc
    try {
      const docRef = doc(db, "reports", reportId);
      const snap = await getDoc(docRef);
      if (!snap.exists()) {
        alert("Report not found.");
        return;
      }
      const data = snap.data();
      selectedReport = { id: snap.id, ...data };

      // populate details
      detailTitle.textContent = selectedReport.issueType || selectedReport.issue || "Report";
      detailSub.textContent = `${selectedReport.barangay || ""} — ${selectedReport.location || ""}`;
      detailIssue.textContent = selectedReport.issueType || selectedReport.issue || "—";
      detailLocation.textContent = `${selectedReport.barangay || ""} • ${selectedReport.location || ""}`;
      detailAuthor.textContent = selectedReport.author || selectedReport.name || "Anonymous";
      detailTimestamp.textContent = fmt(selectedReport.timestamp || selectedReport.createdAt || Date.now());
      detailDesc.textContent = selectedReport.desc || selectedReport.description || "No description provided";
      detailStatus.textContent = selectedReport.status || "Pending";
      // timeline (history array) or lastMessage
      renderTimeline(selectedReport);
      renderGallery(selectedReport);

      // map pin
      const lat = selectedReport.lat ?? (selectedReport.coords ? selectedReport.coords[0] : null);
      const lng = selectedReport.lng ?? (selectedReport.coords ? selectedReport.coords[1] : null);

      if (lat != null && lng != null) {
        setMapPin(lat, lng, false);
        map.setView([lat, lng], 17);
      } else {
        // fallback: try center on barangay approximate
        map.setView([14.5585, 121.0271], 15);
        removeMapPin();
      }

      // rebuild status buttons
      buildStatusButtons(selectedReport.status);
    } catch (err) {
      console.error("selectReport error", err);
    }
  }

  // Render timeline: prefer history array; fallback to lastMessage
  function renderTimeline(report) {
    timelineEl.innerHTML = "";
    const history = report.history || [];
    if (Array.isArray(history) && history.length > 0) {
      history.slice().reverse().forEach(h => {
        const div = document.createElement("div");
        div.style.marginBottom = "8px";
        div.innerHTML = `<div class="muted small">${fmt(h.ts || h.timestamp || h.time || Date.now())}</div><div>${h.text}</div>`;
        timelineEl.appendChild(div);
      });
    } else if (report.lastMessage) {
      const div = document.createElement("div");
      div.innerHTML = `<div class="muted small">${fmt(report.lastUpdate||report.updatedAt||Date.now())}</div><div>${report.lastMessage}</div>`;
      timelineEl.appendChild(div);
    } else {
      timelineEl.innerHTML = `<div class="muted small">No updates yet</div>`;
    }
  }

  // Render proof gallery (proofUrls or stored media)
  function renderGallery(report) {
    proofGallery.innerHTML = "";
    const urls = report.proofUrls || report.proofs || [];
    if (!Array.isArray(urls) || urls.length === 0) {
      proofGallery.innerHTML = `<div class="muted small">No media</div>`;
      return;
    }
    urls.forEach(u => {
      const d = document.createElement("div"); d.className = "thumb";
      if (/\.(mp4|webm|ogg)$/i.test(u) || u.includes("video")) {
        const v = document.createElement("video"); v.src = u; v.controls = true; d.appendChild(v);
      } else {
        const img = new Image(); img.src = u; d.appendChild(img);
      }
      proofGallery.appendChild(d);
    });
  }

  // Map helpers
  function setMapPin(lat, lng, save) {
    if (currentMarker) {
      currentMarker.setLatLng([lat, lng]);
    } else {
      currentMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
      currentMarker.on('dragend', async () => {
        const p = currentMarker.getLatLng();
        latOut.textContent = p.lat.toFixed(6);
        lngOut.textContent = p.lng.toFixed(6);
        if (selectedReport) {
          // save coordinates to Firestore
          await updateDoc(doc(db, "reports", selectedReport.id), { lat: p.lat, lng: p.lng });
          // refresh local
          await loadReports();
          await selectReport(selectedReport.id);
        }
      });
    }
    latOut.textContent = lat.toFixed(6);
    lngOut.textContent = lng.toFixed(6);

    if (save && selectedReport) {
      // persist to Firestore
      updateDoc(doc(db, "reports", selectedReport.id), { lat, lng })
        .catch(err => console.error("save pin error", err));
    }
  }

  function removeMapPin() {
    if (currentMarker) {
      map.removeLayer(currentMarker);
      currentMarker = null;
      latOut.textContent = '—';
      lngOut.textContent = '—';
    }
  }

  // Build status change buttons
  function buildStatusButtons(currentStatus) {
    statusBar.innerHTML = "";
    const statuses = ["Pending", "In Progress", "Resolved", "Closed"];
    statuses.forEach(s => {
      const b = document.createElement("button");
      b.className = "btn";
      if (s === currentStatus) {
        b.style.background = "var(--green)";
        b.style.color = "white";
      } else {
        b.classList.add("secondary");
      }
      b.textContent = s;
      b.addEventListener("click", () => changeStatus(s));
      statusBar.appendChild(b);
    });
  }

  // Change status for selected report
  async function changeStatus(newStatus) {
    if (!selectedReport) { alert("Open a report first"); return; }
    try {
      await updateDoc(doc(db, "reports", selectedReport.id), {
        status: newStatus,
        lastUpdate: serverTimestamp()
      });
      // append a history record
      await updateDoc(doc(db, "reports", selectedReport.id), {
        history: arrayUnion({ ts: new Date().toISOString(), text: `Status changed to ${newStatus}`, author: currentUser.name || 'Official' })
      });
      // refresh
      await loadReports();
      await selectReport(selectedReport.id);
    } catch (err) {
      console.error("changeStatus error", err);
      alert("Failed to change status.");
    }
  }

  // Post update (text + optional media)
  postUpdateBtn.addEventListener("click", async () => {
    if (!selectedReport) { alert("Open a report first"); return; }
    const text = updateText.value.trim();
    const files = Array.from(updateMedia.files || []);
    if (!text && files.length === 0) { alert("Write an update or attach media"); return; }

    // Upload files first
    const uploadedUrls = [];
    try {
      for (const f of files) {
        const path = `proofs/${selectedReport.id}/${Date.now()}_${f.name}`;
        const sfRef = storageRef(storage, path);
        const snap = await uploadBytes(sfRef, f);
        const url = await getDownloadURL(sfRef);
        uploadedUrls.push(url);
      }

      // build update object
      const updateObj = {
        ts: new Date().toISOString(),
        text: text || (uploadedUrls.length ? "Attached media" : ""),
        author: currentUser.name || "Official",
        files: uploadedUrls
      };

      // append to history array and proofUrls
      await updateDoc(doc(db, "reports", selectedReport.id), {
        history: arrayUnion(updateObj),
        proofUrls: arrayUnion(...uploadedUrls),
        lastUpdate: serverTimestamp(),
        lastMessage: text || (uploadedUrls.length ? "Attached media" : "")
      });

      // clear inputs and refresh view
      updateText.value = "";
      updateMedia.value = "";
      await loadReports();
      await selectReport(selectedReport.id);
    } catch (err) {
      console.error("postUpdate error", err);
      alert("Failed to post update. See console.");
    }
  });

  // Wire filter/search/refresh
  filterStatusEl.addEventListener("change", renderReportList);
  searchInputEl.addEventListener("input", () => renderReportList());
  refreshBtn.addEventListener("click", () => loadReports());

  // init: load reports
  loadReports();

  // (Optional) realtime watcher for the reports collection for this barangay:
  // uncomment if you want live updates:
  /*
  (async () => {
    const q = query(collection(db,"reports"), where("barangay","==", currentUser.barangay || "Santa Cruz"));
    onSnapshot(q, snap => {
      allReports = [];
      snap.forEach(s => allReports.push({ id: s.id, ...s.data() }) );
      renderReportList();
      // if selected report changed externally, refresh details
      if (selectedReport) {
        const found = allReports.find(r => r.id === selectedReport.id);
        if (found) selectReport(found.id);
      }
    });
  })();
  */

</script>
</body>
</html>
