<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LGU Dashboard - Makati City</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f6fa;
      margin: 0;
    }
    header {
      background: #003b8e;
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    #logoutBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #f44336;
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #logoutBtn:hover { background: #d32f2f; }

    #connectionStatus {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #f44336;
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 14px;
      transition: background 0.3s;
    }
    #connectionStatus.connected { background: #4caf50; }

    main {
      max-width: 1200px;
      margin: 30px auto;
      background: white;
      padding: 25px 35px;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #003b8e;
      border-bottom: 2px solid #003b8e;
      padding-bottom: 5px;
    }
    .summary {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .summary-card {
      background: #003b8e;
      color: white;
      padding: 20px;
      flex: 1 1 220px;
      margin: 10px;
      text-align: center;
      border-radius: 10px;
    }
    .chart-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-top: 30px;
    }
    canvas {
      width: 400px !important;
      height: 300px !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #003b8e;
      color: white;
    }
    select {
      padding: 5px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <header>
    <div id="connectionStatus">Offline</div>
    <h1>LGU Dashboard - Makati City</h1>
    <h3 id="userInfo">Barangay-Level Monitoring System</h3>
    <button id="logoutBtn">Logout</button>
  </header>

  <main>
    <h2>Summary Overview</h2>
    <div class="summary">
      <div class="summary-card">
        <h3 id="totalReports">0</h3>
        <p>Total Reports</p>
      </div>
      <div class="summary-card" style="background:#ff9800;">
        <h3 id="pendingCount">0</h3>
        <p>Pending</p>
      </div>
      <div class="summary-card" style="background:#2196f3;">
        <h3 id="inProgressCount">0</h3>
        <p>In Progress</p>
      </div>
      <div class="summary-card" style="background:#4caf50;">
        <h3 id="resolvedCount">0</h3>
        <p>Resolved</p>
      </div>
    </div>

    <h2>Analytics & Trends</h2>
    <div class="chart-container">
      <div>
        <h3>Reports by Barangay</h3>
        <canvas id="barangayChart"></canvas>
      </div>
      <div>
        <h3>Reports by Issue Type</h3>
        <canvas id="issueTypeChart"></canvas>
      </div>
    </div>

    <h2>Recent Reports</h2>
    <select id="barangayFilter">
      <option value="all">All Barangays</option>
    </select>

    <table id="reportTable">
      <thead>
        <tr>
          <th>Barangay</th>
          <th>Reporter</th>
          <th>Issue</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <!-- ✅ Firestore + Chart Integration -->
 <script type="module">
  import { app, db } from "./firebase-config.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if (!currentUser || currentUser.role !== "lgu") {
    alert("Access denied. LGU login required.");
    window.location.href = "index.html";
  } else {
    document.getElementById("userInfo").textContent = `Welcome, ${currentUser.name} (${currentUser.email})`;
  }

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
  });

  // Firestore: Fetch all reports
  const reportRef = collection(db, "reports");
  const snapshot = await getDocs(reportRef);
  const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  console.log("✅ Reports loaded:", reports);

  // Update Summary
  const totalReports = document.getElementById("totalReports");
  const pendingCount = document.getElementById("pendingCount");
  const inProgressCount = document.getElementById("inProgressCount");
  const resolvedCount = document.getElementById("resolvedCount");
  const tableBody = document.querySelector("#reportTable tbody");
  const filter = document.getElementById("barangayFilter");
    document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
    });
  function updateSummary() {
    totalReports.textContent = reports.length;
    pendingCount.textContent = reports.filter(r => r.status === "Pending").length;
    inProgressCount.textContent = reports.filter(r => r.status === "In Progress").length;
    resolvedCount.textContent = reports.filter(r => r.status === "Resolved").length;
  }

  function loadReports(filterValue = "all") {
    tableBody.innerHTML = "";
    reports
      .filter(r => filterValue === "all" || r.barangay === filterValue)
      .forEach(r => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${r.barangay}</td>
          <td>${r.author || "N/A"}</td>
          <td>${r.issueType || "Unknown"}</td>
          <td>${r.status}</td>
          <td>${new Date(r.timestamp).toLocaleString()}</td>
        `;
        tableBody.appendChild(row);
      });
  }

  filter.addEventListener("change", e => loadReports(e.target.value));

  function updateCharts() {
    const barangayCounts = {};
    const issueTypeCounts = {};

    reports.forEach(r => {
      barangayCounts[r.barangay] = (barangayCounts[r.barangay] || 0) + 1;
      issueTypeCounts[r.issueType] = (issueTypeCounts[r.issueType] || 0) + 1;
    });

    barangayChart.data.labels = Object.keys(barangayCounts);
    barangayChart.data.datasets[0].data = Object.values(barangayCounts);
    barangayChart.update();

    issueTypeChart.data.labels = Object.keys(issueTypeCounts);
    issueTypeChart.data.datasets[0].data = Object.values(issueTypeCounts);
    issueTypeChart.update();
  }

  const barangayChart = new Chart(document.getElementById("barangayChart"), {
    type: "bar",
    data: { labels: [], datasets: [{ label: "Reports per Barangay", backgroundColor: "#003b8e", data: [] }] }
  });

  const issueTypeChart = new Chart(document.getElementById("issueTypeChart"), {
    type: "pie",
    data: { labels: [], datasets: [{ label: "Issues", backgroundColor: ["#ff9800", "#4caf50", "#f44336", "#2196f3"], data: [] }] }
  });

  updateSummary();
  loadReports();
  updateCharts();
</script>
</body>
</html>
